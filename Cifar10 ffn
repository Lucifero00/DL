import tensorflow as tf
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import Dense, Flatten
from tensorflow.keras.datasets import cifar10
from sklearn.model_selection import train_test_split
from sklearn.metrics import classification_report
import numpy as np
import matplotlib.pyplot as plt

# Step 1: Load CIFAR-10 dataset
(x_train, y_train), (x_test, y_test) = cifar10.load_data()
class_names = ['airplane', 'automobile', 'bird', 'cat', 'deer',
               'dog', 'frog', 'horse', 'ship', 'truck']

# Step 2: Normalize and split
x_train, x_test = x_train / 255.0, x_test / 255.0
x_train_split, x_val, y_train_split, y_val = train_test_split(x_train, y_train, test_size=0.2, random_state=42)

# Step 3: One-hot encode labels
y_train_split_enc = tf.keras.utils.to_categorical(y_train_split, 10)
y_val_enc = tf.keras.utils.to_categorical(y_val, 10)

# Step 4: Build Feed Forward Neural Network (FFNN)
model = Sequential([
    Flatten(input_shape=(32, 32, 3)),
    Dense(512, activation='relu'),
    Dense(256, activation='relu'),
    Dense(128, activation='relu'),
    Dense(10, activation='softmax')
])

model.compile(optimizer='adam', loss='categorical_crossentropy', metrics=['accuracy'])

# Step 5: Train the model
history = model.fit(x_train_split, y_train_split_enc,
                    validation_data=(x_val, y_val_enc),
                    epochs=10, batch_size=32)

# Step 6: Plot accuracy
plt.plot(history.history['accuracy'], label='Train Acc')
plt.plot(history.history['val_accuracy'], label='Val Acc')
plt.title('Model Accuracy')
plt.xlabel('Epoch')
plt.ylabel('Accuracy')
plt.legend()
plt.show()

# Step 7: Evaluate on validation set
y_val_pred = np.argmax(model.predict(x_val), axis=1)
print(classification_report(y_val.flatten(), y_val_pred, target_names=class_names))

# Step 8: Show sample predictions
num_images = 5
idxs = np.random.choice(len(x_test), num_images, replace=False)
pred_classes = np.argmax(model.predict(x_test[idxs]), axis=1)

plt.figure(figsize=(15,3))
for i, idx in enumerate(idxs):
    plt.subplot(1, num_images, i+1)
    plt.imshow(x_test[idx])
    plt.title(f"Pred: {class_names[pred_classes[i]]}")
    plt.axis('off')
plt.tight_layout()
plt.show()
